\chapter{微处理器体系架构}

如果暂时撇开硬件不谈，可以说微处理器体系架构属于嵌入式开发的最底层的硬件知识。
我暂时还说不清楚这部分知识属于 EE，还是 CS。
但是，可以肯定我们从处理器架构手册中获取的芯片运行原理等信息与处理器的开发有交集，
只是说处理器的开发需要更加详尽且完善的知识体系，而紧贴处理器硬件的软件开发也需要这部分原理知识以便正确且高效的使用相关的处理器。

微处理器体系架构方面的知识建立了处理器硬件与软件的桥梁，是嵌入式开发所绕不开的话题。
所以，我们从微处理器体系架构开始，逐步的完善并建立嵌入式开发的基础知识体系。

本章主要根据相关的编程和架构手册来讲述两种微处理器架构，一种是目前占市场主导地位的 ARMv8 架构，另外一种则是开源的 RISC-V 指令集架构。
之所以选择这两种指令集架构进行学习，是因为它们的流行度和潜力。

下面让我们从 ARMv8 开始。

\section{ARMv8}

ARM 公司在 2013 年发布了它的 64-bit ARMv8 架构。
ARMv8 实现了 32-bit ARMv7 的兼容。
做出了以下重要升级：\footnote{
  这里翻译或讲述的原版手册是 {ARM® Cortex®-A Series Programmer’s Guide for ARMv8-A}\cite{armpg}
}

\begin{description}
    \item[Large physical address] 更大的物理内存，使处理器能够访问超过 4GB 的物理内存。
    \item[64-bit virtual addressing] 使虚拟内存突破 4GB 限制。
    这对于使用内存映射文件 I/O 或稀疏寻址的现代桌面和服务器软件很重要。
    \item[Automatic event signaling] 可以实现节能、高性能的自旋锁。
    \item[Larger register files] 31 个 64 位通用寄存器可提高性能并减少堆栈使用。
    \item[Efficient 64-bit immediate generation] 降低对 literal pool 的需求。
    \item[Large PC-relative addressing range] 一个 +/‑4GB 的寻址范围，用于在共享库和与位置无关的可执行文件中进行有效的数据寻址。
    \item[Additional 16KB and 64KB translation granules] 降低了翻译后备缓冲区 (TLB) 未命中率和页面遍历深度。
    \item[New exception model] 降低了操作系统和管理程序软件的复杂性。
    \item[Efficient cache management] 用户空间缓存操作提高了动态代码生成效率。
    使用数据缓存零指令快速清除数据缓存。
    \item[Hardware-accelerated cryptography] 软件加密性能提高 3 到 10 倍。
      这对于小粒度解密和加密非常有用，因为太小而无法有效地卸载到硬件加速器（too small to offload to a hardware accelerator），例如 https。
    \item[Load-Acquire, Store-Release instructions] 专为 C++11、C11、Java 内存模型而设计。
    它们通过消除显式内存屏障指令来提高线程安全代码的性能。
    \item[NEON double-precision floating-point advanced SIMD] 使得 SIMD 矢量化能够应用于更广泛的算法集，例如科学计算、高性能计算 (HPC) 和超级计算机。
\end{description}

\subsection{Contex-A57 处理器}

目前 ARM 处理器已经更新到 X2，但是对于学习它的体系架构来说，A57 或 A53 已经足够适用，也足够经典。
我们将手册中的框架图拿过来感性的认识处理器的内部结构。

Cortex‑A57 处理器 Cortex‑A57 处理器面向移动和企业计算应用，包括计算密集型 64 位应用，例如高端计算机、平板电脑和服务器产品。
它可以与 Cortex‑A53 处理器一起使用到 ARM big.LITTLE 配置中，兼顾性能和功耗。

Cortex‑A57 处理器具有与其他处理器的高速缓存一致性互操作性，包括用于 GPU 计算的 ARM Mali™ 系列图形处理单元 (GPU)，并为高性能企业应用程序提供可选的可靠性和可扩展性功能。
它提供了比 ARMv7 架构的 Cortex‑A15 处理器更高的性能，并具有更高的能效水平。
加密扩展使加密算法的性能比上一代处理器提高 10 倍以上。

\Figure[caption={Contex-A57}, label={fig:contex-a57}, width=0.7]{A57}

Cortex‑A57 处理器完全实现了 ARMv8‑A 架构。
它支持多核操作，在单个集群中具有一到四核多处理器。
通过 AMBA5 CHI 或 AMBA 4 ACE 技术，可以实现多个一致的 SMP 集群。
可通过 CoreSight 技术进程调试和跟踪。

Cortex‑A57 处理器具有以下特性：

\begin{itemize}
  \item 乱序，多于 15 级流水线。
  \item 省电功能包括路径预测、标记缩减和缓存查找抑制。
  \item 通过重复执行资源增加峰值指令吞吐量。
    具有本地化解码、3 个宽解码带宽的功率优化指令解码。
  \item 性能优化的 L2 缓存设计使集群中的多个核心可以同时访问 L2。
\end{itemize}

\input{ma/armv8/armv8-basic}
\input{ma/armv8/regs}
\input{ma/armv8/isa-in-nutshell}
\input{ma/armv8/a64-isa}
\input{ma/armv8/float-neon}
\input{ma/armv8/abi}
\input{ma/armv8/exception}
\input{ma/armv8/cache}
\input{ma/armv8/mmu}
\input{ma/armv8/memory-ordering}
\input{ma/armv8/multi-core-processors}

\subsection{Others}

\section{RISC-V}

\subsection{Privileged Architecture}

\subsection{Unprivileged ISA}

\section{内存层级}

\section{每个程序员都应该知道的内存知识}

关于内存相关的知识，强烈建议阅读
\href{https://people.freebsd.org/~lstewart/articles/cpumemory.pdf}{What Every Programmer Should Know About Memory}。


% nvim: set ts=2 sts=2 sw=2 et:
